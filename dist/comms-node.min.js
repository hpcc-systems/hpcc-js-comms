"use strict";function scopedLogger(e,t){return void 0===t&&(t=!0),t&&logger$1.filter(e),new ScopedLogging(e)}function trim(e,t){if("string"!=typeof t)return e;if(0===t.length)return e;for(;0===e.indexOf(t);)e=e.substring(1);for(;endsWith(e,t);)e=e.substring(0,e.length-1);return e}function endsWith(e,t,o){var n=e.toString();("number"!=typeof o||!isFinite(o)||Math.floor(o)!==o||o>n.length)&&(o=n.length),o-=t.length;var r=n.lastIndexOf(t,o);return-1!==r&&r===o}function join(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return(e.length&&e[0].length&&"/"===e[0].charAt(0)?"/":"")+e.map(function(e){return trim(e,"/")}).join("/")}function initNodeRequest(e){_nodeRequest=e}Object.defineProperty(exports,"__esModule",{value:!0});var nodeRequest=require("request"),tslib_1=require("tslib"),safeBuffer=require("safe-buffer"),Stack=function(){function e(){this.stack=[]}return e.prototype.push=function(e){return this.stack.push(e),e},e.prototype.pop=function(){return this.stack.pop()},e.prototype.top=function(){return this.stack.length?this.stack[this.stack.length-1]:void 0},e.prototype.depth=function(){return this.stack.length},e}(),root=new Function("try{return global;}catch(e){return window;}")(),isNode=new Function("try{return this===global;}catch(e){return false;}"),Level;!function(e){e[e.debug=0]="debug",e[e.info=1]="info",e[e.notice=2]="notice",e[e.warning=3]="warning",e[e.error=4]="error",e[e.critical=5]="critical",e[e.alert=6]="alert",e[e.emergency=7]="emergency"}(Level||(Level={}));var colours={debug:"cyan",info:"green",notice:"grey",warning:"blue",errpr:"red",critical:"magenta",alert:"magenta",emergency:"magenta"},Logging=function(){function e(){this._levelStack=new Stack,this._level=Level.error,this._filter=""}return e.Instance=function(){return this._instance||(this._instance=new this)},e.prototype.stringify=function(e){var t=[];return JSON.stringify(e,function(e,o){if("object"==typeof o&&null!==o){if(-1!==t.indexOf(o))return;t.push(o)}return o},2)},e.prototype.log=function(e,t,o){if(!(e<this._level||this._filter&&this._filter!==t)){var n=new Date,r=n.toISOString();"string"!=typeof o&&(o=this.stringify(o)),isNode?console.log("["+r+"] "+Level[e].toUpperCase()+" "+t+":  "+o):console.log("["+r+"] %c"+Level[e].toUpperCase()+"%c "+t+":  "+o,"color:"+colours[Level[e]],"")}},e.prototype.debug=function(e,t){this.log(Level.debug,e,t)},e.prototype.info=function(e,t){this.log(Level.info,e,t)},e.prototype.notice=function(e,t){this.log(Level.notice,e,t)},e.prototype.warning=function(e,t){this.log(Level.warning,e,t)},e.prototype.error=function(e,t){this.log(Level.error,e,t)},e.prototype.critical=function(e,t){this.log(Level.critical,e,t)},e.prototype.alert=function(e,t){this.log(Level.alert,e,t)},e.prototype.emergency=function(e,t){this.log(Level.emergency,e,t)},e.prototype.level=function(e){return arguments.length?(this._level=e,this):this._level},e.prototype.pushLevel=function(e){return this._levelStack.push(this._level),this._level=e,this},e.prototype.popLevel=function(){return this._level=this._levelStack.pop(),this},e.prototype.filter=function(e){return arguments.length?(this._filter=e,this):this._filter},e}(),logger$1=Logging.Instance(),ScopedLogging=function(){function e(e){this._scopeID=e}return e.prototype.debug=function(e){logger$1.debug(this._scopeID,e)},e.prototype.info=function(e){logger$1.info(this._scopeID,e)},e.prototype.notice=function(e){logger$1.notice(this._scopeID,e)},e.prototype.warning=function(e){logger$1.warning(this._scopeID,e)},e.prototype.error=function(e){logger$1.error(this._scopeID,e)},e.prototype.critical=function(e){logger$1.critical(this._scopeID,e)},e.prototype.alert=function(e){logger$1.alert(this._scopeID,e)},e.prototype.emergency=function(e){logger$1.emergency(this._scopeID,e)},e.prototype.pushLevel=function(e){return logger$1.pushLevel(e),this},e.prototype.popLevel=function(){return logger$1.popLevel(),this},e}(),logger$$1=scopedLogger("comms/connection.ts");!function(e){e[e.POST=0]="POST",e[e.GET=1]="GET",e[e.JSONP=2]="JSONP"}(exports.RequestType||(exports.RequestType={})),function(e){e[e.JSON=0]="JSON",e[e.TEXT=1]="TEXT"}(exports.ResponseType||(exports.ResponseType={}));var DefaultOptions={type:exports.RequestType.POST,baseUrl:"",userID:"",password:"",rejectUnauthorized:!1,timeoutSecs:60},_nodeRequest=null,_d3Request=null,Connection=function(){function e(e){this.opts(e)}return e.prototype.serialize=function(e,t){var o=this;if(void 0===t&&(t=""),t&&(t+="."),"object"!=typeof e)return encodeURIComponent(e);var n=[],r=this;for(var s in e)!function(s){if(e.hasOwnProperty(s))if(e[s]instanceof Array){var i=!1;e[s].forEach(function(e,r){"object"==typeof e?(i=!0,n.push(o.serialize(e,t+encodeURIComponent(s+"."+r)))):n.push(t+encodeURIComponent(s+"_i"+r)+"="+o.serialize(e))}),i&&n.push(t+encodeURIComponent(s+".itemcount")+"="+e[s].length)}else"object"==typeof e[s]?n.push(r.serialize(e[s],t+encodeURIComponent(s))):n.push(t+encodeURIComponent(s)+"="+encodeURIComponent(e[s]))}(s);return n.join("&")},e.prototype.deserialize=function(e){return JSON.parse(e)},e.prototype.nodeRequestSend=function(e,t,o,n){var r=this;return void 0===n&&(n=exports.ResponseType.JSON),new Promise(function(s,i){var p={method:e,uri:join(r._opts.baseUrl,t),auth:{user:r._opts.userID,pass:r._opts.password,sendImmediately:!0},username:r._opts.userID,password:r._opts.password,timeout:1e3*r._opts.timeoutSecs},u="Basic "+btoa(r._opts.userID+":"+r._opts.password);switch(e){case"GET":p.headers={Authorization:u},p.uri+="?"+r.serialize(o);break;case"POST":p.headers={"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded",Authorization:u},p.rejectUnauthorized=r._opts.rejectUnauthorized,p.body=r.serialize(o)}_nodeRequest(p,function(e,t,o){e?i(new Error(e)):t&&200===t.statusCode?s(n===exports.ResponseType.JSON?r.deserialize(o):o):i(new Error(o))})})},e.prototype.d3Send=function(e,t,o,n){var r=this;return void 0===n&&(n=exports.ResponseType.JSON),new Promise(function(s,i){var p={method:e,uri:join(r._opts.baseUrl,t),auth:{user:r._opts.userID,pass:r._opts.password,sendImmediately:!0},username:r._opts.userID,password:r._opts.password};switch(e){case"GET":p.uri+="?"+r.serialize(o);break;case"POST":p.headers={"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},p.rejectUnauthorized=r._opts.rejectUnauthorized,p.body=r.serialize(o)}var u=_d3Request(p.uri).timeout(1e3*r._opts.timeoutSecs);"POST"===e&&u.header("X-Requested-With","XMLHttpRequest").header("Content-Type","application/x-www-form-urlencoded").header("Origin",null),u.send(e,p.body,function(e,t){e?i(new Error(e)):t&&200===t.status?s(n===exports.ResponseType.JSON?r.deserialize(t.responseText):t.responseText):i(new Error(t.responseText))})})},e.prototype.post=function(e,t,o){if(void 0===o&&(o=exports.ResponseType.JSON),_nodeRequest)return this.nodeRequestSend("POST",e,t,o);if(_d3Request)return this.d3Send("POST",e,t,o);throw new Error("No transport")},e.prototype.get=function(e,t,o){if(void 0===o&&(o=exports.ResponseType.JSON),_nodeRequest)return this.nodeRequestSend("GET",e,t,o);if(_d3Request)return this.d3Send("GET",e,t,o);throw new Error("No transport")},e.prototype.jsonp=function(e,t,o){var n=this;return void 0===t&&(t={}),void 0===o&&(o=exports.ResponseType.JSON),new Promise(function(r,s){function i(){delete window[u],document.body.removeChild(l)}var p=1e3*n._opts.timeoutSecs,u="jsonp_callback_"+Math.round(999999*Math.random()),c=n;window[u]=function(e){p=0,i(),r(o===exports.ResponseType.JSON&&"string"==typeof e?c.deserialize(e):e)};var l=document.createElement("script"),a=join(n._opts.baseUrl,e);a+=a.indexOf("?")>=0?"&":"?",l.src=a+"jsonp="+u+"&"+n.serialize(t),document.body.appendChild(l);var f=setInterval(function(){p<=0?clearInterval(f):(p-=5e3,p<=0?(clearInterval(f),logger$$1.error("Request timeout:  "+l.src),i(),s(Error("Request timeout:  "+l.src))):logger$$1.debug("Request pending ("+p/1e3+" sec):  "+l.src))},5e3)})},e.prototype.opts=function(e){return 0===arguments.length?this._opts:(this._opts=tslib_1.__assign({},DefaultOptions,e),this)},e.prototype.send=function(e,t,o){switch(void 0===o&&(o=exports.ResponseType.JSON),this._opts.type){case exports.RequestType.JSONP:return this.jsonp(e,t,o);case exports.RequestType.GET:return this.get(e,t,o);case exports.RequestType.POST:default:return this.post(e,t,o)}},e.prototype.clone=function(){return new e(this.opts())},e}(),version="0.0.1";initNodeRequest(nodeRequest),"undefined"==typeof btoa&&(global.btoa=function(e){return safeBuffer.Buffer.from(e||"","utf8").toString("base64")}),exports.version=version,exports.Connection=Connection;
//# sourceMappingURL=comms-node.min.js.map
